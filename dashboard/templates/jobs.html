{% extends "base.html" %}

{% block title %}Active Jobs ‚Äî ISLA Builders{% endblock %}

{% block content %}
<header class="main-header">
  <h2>Active Jobs</h2>
  <div class="header-meta">
    <span class="last-updated" id="lastUpdated">Loading...</span>
    <a href="https://app.jobtread.com" target="_blank" class="btn btn-primary">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
      </svg>
      Open JobTread
    </a>
  </div>
</header>

<!-- Summary Cards -->
<div class="metrics-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: var(--space-6);">
  <div class="metric-card">
    <div class="metric-label">Active Jobs</div>
    <div class="metric-value" id="metric-active">-</div>
    <div class="metric-trend">Currently in progress</div>
  </div>
  <div class="metric-card">
    <div class="metric-label">This Month</div>
    <div class="metric-value" id="metric-month">-</div>
    <div class="metric-trend">Jobs started</div>
  </div>
  <div class="metric-card">
    <div class="metric-label">Completed</div>
    <div class="metric-value" id="metric-completed">-</div>
    <div class="metric-trend">This month</div>
  </div>
  <div class="metric-card">
    <div class="metric-label">Total Revenue</div>
    <div class="metric-value currency" id="metric-revenue">-</div>
    <div class="metric-trend">Active jobs value</div>
  </div>
</div>

<!-- Filters -->
<div class="card" style="margin-bottom: var(--space-4); padding: var(--space-3) var(--space-4);">
  <div style="display: flex; gap: var(--space-4); align-items: center; flex-wrap: wrap;">
    <div style="display: flex; align-items: center; gap: var(--space-2);">
      <label style="font-size: 12px; color: var(--text-muted); font-weight: 500;">Status:</label>
      <select id="filterStatus" class="select-control" onchange="filterJobs()">
        <option value="all">All Jobs</option>
        <option value="active">Active</option>
        <option value="completed">Completed</option>
        <option value="on_hold">On Hold</option>
      </select>
    </div>
    <div style="flex: 1;"></div>
    <input type="search" id="searchJobs" placeholder="Search jobs..." class="input-control" style="width: 200px;" oninput="filterJobs()">
  </div>
</div>

<!-- Jobs Grid -->
<div class="jobs-grid" id="jobsGrid">
  <div class="loading" style="grid-column: 1 / -1;">Loading jobs from JobTread</div>
</div>

<style>
.select-control, .input-control {
  padding: 6px 10px;
  border: 1px solid var(--border-default);
  border-radius: var(--radius-sm);
  font-size: 13px;
  background: var(--bg-surface);
  color: var(--text-primary);
}

.jobs-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: var(--space-4);
}

.job-card {
  background: var(--bg-surface);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-md);
  padding: var(--space-5);
  box-shadow: var(--shadow-sm);
  transition: box-shadow 0.15s ease, border-color 0.15s ease;
}

.job-card:hover {
  box-shadow: var(--shadow-md);
  border-color: var(--border-strong);
}

.job-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--space-3);
}

.job-number {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-muted);
  background: var(--bg-inset);
  padding: 2px 6px;
  border-radius: 4px;
}

.job-name {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: var(--space-2);
  line-height: 1.3;
}

.job-client {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: var(--space-3);
}

.job-address {
  font-size: 12px;
  color: var(--text-muted);
  display: flex;
  align-items: flex-start;
  gap: var(--space-2);
  margin-bottom: var(--space-4);
}

.job-address svg {
  flex-shrink: 0;
  margin-top: 2px;
}

.job-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: var(--space-3);
  border-top: 1px solid var(--border-subtle);
}

.job-date {
  font-size: 11px;
  color: var(--text-muted);
}
</style>
{% endblock %}

{% block scripts %}
<script>
let allJobs = [];

async function loadJobs() {
  try {
    const response = await fetch('/api/jobs');
    const data = await response.json();
    allJobs = data.jobs || [];
    updateMetrics();
    renderJobsGrid(allJobs);
    updateLastUpdated();
  } catch (error) {
    console.error('Error loading jobs:', error);
  }
}

function updateMetrics() {
  const active = allJobs.filter(j => j.status === 'active' || j.status === 'in_progress').length;
  const completed = allJobs.filter(j => j.status === 'completed').length;
  
  document.getElementById('metric-active').textContent = active || allJobs.length;
  document.getElementById('metric-month').textContent = allJobs.length;
  document.getElementById('metric-completed').textContent = completed;
  document.getElementById('metric-revenue').textContent = '-';
}

function filterJobs() {
  const status = document.getElementById('filterStatus').value;
  const search = document.getElementById('searchJobs').value.toLowerCase();
  
  let filtered = allJobs;
  
  if (status !== 'all') {
    filtered = filtered.filter(j => j.status === status);
  }
  
  if (search) {
    filtered = filtered.filter(j => 
      (j.name || '').toLowerCase().includes(search) ||
      (j.client || '').toLowerCase().includes(search) ||
      (j.address || '').toLowerCase().includes(search) ||
      (j.number || '').toString().includes(search)
    );
  }
  
  renderJobsGrid(filtered);
}

function renderJobsGrid(jobs) {
  const grid = document.getElementById('jobsGrid');
  
  if (!jobs.length) {
    grid.innerHTML = `
      <div class="empty-state" style="grid-column: 1 / -1;">
        <div class="empty-state-icon">üèóÔ∏è</div>
        <div class="empty-state-text">No jobs found</div>
      </div>
    `;
    return;
  }
  
  grid.innerHTML = jobs.map(j => `
    <div class="job-card">
      <div class="job-card-header">
        <span class="job-number">#${j.number || '-'}</span>
        <span class="badge ${j.status}">${j.status}</span>
      </div>
      <div class="job-name">${escapeHtml(j.name)}</div>
      <div class="job-client">${escapeHtml(j.client)}</div>
      <div class="job-address">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
        <span>${escapeHtml(j.address || 'No address')}</span>
      </div>
      <div class="job-meta">
        <span class="job-date">Started ${formatDate(j.created)}</span>
        <a href="https://app.jobtread.com" target="_blank" class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;">
          Details
        </a>
      </div>
    </div>
  `).join('');
}

function updateLastUpdated() {
  const now = new Date();
  document.getElementById('lastUpdated').textContent = 
    `Updated ${now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`;
}

document.addEventListener('DOMContentLoaded', loadJobs);
</script>
{% endblock %}
