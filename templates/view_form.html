{% extends 'base.html' %}

{% block title %}{{ 'Edit' if view else 'New' }} View - CRM{% endblock %}

{% block content %}
<div class="card" style="max-width: 600px;">
    <div class="card-header">
        <h2>{{ 'Edit' if view else 'New' }} View</h2>
    </div>
    <div class="card-body">
        <form method="POST">
            <div class="form-group">
                <label class="form-label">View Name *</label>
                <input type="text" name="name" class="form-control" required
                    value="{{ view['name'] if view else '' }}"
                    placeholder="e.g., Sales Team View">
            </div>

            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea name="description" class="form-control" rows="2"
                    placeholder="Optional description">{{ view['description'] if view else '' }}</textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Select Fields to Include</label>
                {% if all_fields %}
                <p class="text-muted text-sm" style="margin-bottom: 0.75rem;">
                    Check the fields you want to appear in this view. Drag to reorder.
                </p>

                <div id="fieldsList">
                    {% for field in all_fields %}
                    <div class="visibility-item" data-field-id="{{ field['id'] }}">
                        <div class="drag-handle">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="8" y1="6" x2="16" y2="6"></line>
                                <line x1="8" y1="12" x2="16" y2="12"></line>
                                <line x1="8" y1="18" x2="16" y2="18"></line>
                            </svg>
                        </div>
                        <label class="visibility-label">
                            <input type="checkbox" name="field_{{ field['id'] }}"
                                {% if field['id'] in selected_field_ids %}checked{% endif %}>
                            <span>{{ field['name'] }}</span>
                        </label>
                        <input type="hidden" name="sequence_{{ field['id'] }}" value="{{ loop.index0 }}"
                            class="sequence-input">
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state" style="padding: 1rem;">
                    <p class="text-muted">No custom fields available. <a href="{{ url_for('add_field') }}">Add fields first</a>.</p>
                </div>
                {% endif %}
            </div>

            <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                <button type="submit" class="btn btn-primary">
                    {{ 'Update' if view else 'Create' }} View
                </button>
                <a href="{{ url_for('list_views') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

<style>
    .visibility-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: 0.375rem;
        margin-bottom: 0.5rem;
        cursor: move;
    }

    .visibility-item:hover {
        background: var(--gray-100);
    }

    .drag-handle {
        color: var(--gray-400);
    }

    .visibility-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
        cursor: pointer;
    }

    .visibility-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
    }
</style>

<script>
    // Simple drag-and-drop reordering
    let draggedItem = null;

    document.querySelectorAll('.visibility-item').forEach(item => {
        item.addEventListener('dragstart', function (e) {
            draggedItem = this;
            this.style.opacity = '0.5';
        });

        item.addEventListener('dragend', function (e) {
            this.style.opacity = '1';
            draggedItem = null;
            updateSequences();
        });

        item.addEventListener('dragover', function (e) {
            e.preventDefault();
        });

        item.addEventListener('drop', function (e) {
            e.preventDefault();
            if (draggedItem !== this) {
                const list = document.getElementById('fieldsList');
                const items = [...list.querySelectorAll('.visibility-item')];
                const draggedIdx = items.indexOf(draggedItem);
                const targetIdx = items.indexOf(this);

                if (draggedIdx < targetIdx) {
                    this.parentNode.insertBefore(draggedItem, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedItem, this);
                }
            }
        });

        item.setAttribute('draggable', 'true');
    });

    function updateSequences() {
        document.querySelectorAll('.visibility-item').forEach((item, idx) => {
            item.querySelector('.sequence-input').value = idx;
        });
    }
</script>
{% endblock %}
