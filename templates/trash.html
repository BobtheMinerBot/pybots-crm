{% extends 'base.html' %}

{% block title %}Trash - CRM{% endblock %}

{% block content %}
<div class="toolbar">
    <h2 style="margin: 0;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 0.5rem;">
            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        </svg>
        Trash
    </h2>
    <div style="margin-left: auto; display: flex; gap: 0.5rem;">
        {% if leads %}
        <button type="button" class="btn btn-danger" onclick="emptyTrash()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
            Empty Trash
        </button>
        {% endif %}
        <a href="{{ url_for('leads') }}" class="btn btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"></path>
            </svg>
            Back to Leads
        </a>
    </div>
</div>

<div class="card">
    {% if leads %}
    <div class="card-body" style="padding: 0.75rem 1rem; background: var(--warning-light); border-bottom: 1px solid var(--gray-200);">
        <p class="text-sm" style="margin: 0; color: var(--gray-700);">
            <strong>{{ leads | length }}</strong> lead(s) in trash. Deleted leads are permanently removed after 30 days.
        </p>
    </div>
    <table class="grid-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Status (when deleted)</th>
                <th>Deleted</th>
                <th style="width: 200px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for lead in leads %}
            <tr data-lead-id="{{ lead['id'] }}">
                <td>
                    <strong>{{ lead['name'] }}</strong>
                </td>
                <td class="text-sm">{{ lead['email'] or '-' }}</td>
                <td class="text-sm">{{ lead['phone'] or '-' }}</td>
                <td>
                    <span class="badge badge-{{ lead['status'] | lower | replace(' ', '-') }}">{{ lead['status'] }}</span>
                </td>
                <td class="text-muted text-sm">{{ lead['deleted_at'] | strftime('%b %d, %Y at %I:%M %p') }}</td>
                <td>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn btn-primary btn-sm" onclick="restoreLead({{ lead['id'] }}, '{{ lead['name'] | replace("'", "\\'") }}')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                                <path d="M3 3v5h5"></path>
                            </svg>
                            Restore
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" onclick="permanentDelete({{ lead['id'] }}, '{{ lead['name'] | replace("'", "\\'") }}')">
                            Delete Forever
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state" style="padding: 3rem;">
        <div class="empty-state-icon" style="margin-bottom: 1rem;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--gray-400)" stroke-width="1.5">
                <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        </div>
        <h3 style="margin: 0 0 0.5rem; color: var(--gray-700);">Trash is empty</h3>
        <p class="text-muted">Deleted leads will appear here and can be restored.</p>
        <a href="{{ url_for('leads') }}" class="btn btn-secondary" style="margin-top: 1rem;">
            Back to Leads
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    function restoreLead(leadId, leadName) {
        showConfirmDialog({
            title: 'Restore Lead',
            message: `Restore "${leadName}" back to your leads?`,
            confirmText: 'Restore',
            cancelText: 'Cancel',
            type: 'info',
            onConfirm: () => {
                fetch(`/trash/${leadId}/restore`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                }).then(response => {
                    if (response.ok) {
                        showToast(`"${leadName}" has been restored`, 'success');
                        // Remove the row from the table
                        const row = document.querySelector(`tr[data-lead-id="${leadId}"]`);
                        if (row) {
                            row.style.transition = 'opacity 0.3s, transform 0.3s';
                            row.style.opacity = '0';
                            row.style.transform = 'translateX(20px)';
                            setTimeout(() => {
                                row.remove();
                                // Check if table is now empty
                                if (document.querySelectorAll('tbody tr').length === 0) {
                                    window.location.reload();
                                }
                            }, 300);
                        }
                    } else {
                        showToast('Failed to restore lead', 'error');
                    }
                }).catch(() => {
                    showToast('Failed to restore lead', 'error');
                });
            }
        });
    }

    function permanentDelete(leadId, leadName) {
        showConfirmDialog({
            title: 'Delete Forever',
            message: `Permanently delete "${leadName}"? This action cannot be undone and all data will be lost.`,
            confirmText: 'Delete Forever',
            cancelText: 'Cancel',
            type: 'danger',
            onConfirm: () => {
                fetch(`/trash/${leadId}/permanent-delete`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                }).then(response => {
                    if (response.ok) {
                        showToast(`"${leadName}" has been permanently deleted`, 'success');
                        // Remove the row from the table
                        const row = document.querySelector(`tr[data-lead-id="${leadId}"]`);
                        if (row) {
                            row.style.transition = 'opacity 0.3s, transform 0.3s';
                            row.style.opacity = '0';
                            row.style.transform = 'translateX(-20px)';
                            setTimeout(() => {
                                row.remove();
                                // Check if table is now empty
                                if (document.querySelectorAll('tbody tr').length === 0) {
                                    window.location.reload();
                                }
                            }, 300);
                        }
                    } else {
                        showToast('Failed to delete lead', 'error');
                    }
                }).catch(() => {
                    showToast('Failed to delete lead', 'error');
                });
            }
        });
    }

    function emptyTrash() {
        const count = document.querySelectorAll('tbody tr').length;
        showConfirmDialog({
            title: 'Empty Trash',
            message: `Permanently delete all ${count} lead(s) in trash? This action cannot be undone.`,
            confirmText: 'Empty Trash',
            cancelText: 'Cancel',
            type: 'danger',
            onConfirm: () => {
                fetch('/trash/empty', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                }).then(response => {
                    if (response.ok) {
                        showToast(`${count} lead(s) permanently deleted`, 'success');
                        setTimeout(() => window.location.reload(), 500);
                    } else {
                        showToast('Failed to empty trash', 'error');
                    }
                }).catch(() => {
                    showToast('Failed to empty trash', 'error');
                });
            }
        });
    }
</script>
{% endblock %}
