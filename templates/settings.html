{% extends 'base.html' %}

{% block title %}Settings - CRM{% endblock %}

{% block content %}
<div class="settings-layout">
    <!-- Settings Navigation -->
    <nav class="settings-nav">
        <a href="#account" class="settings-nav-item active" data-section="account">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
            Account
        </a>
        <a href="#integrations" class="settings-nav-item" data-section="integrations">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 20V10"></path>
                <path d="M12 20V4"></path>
                <path d="M6 20v-6"></path>
            </svg>
            API & Integrations
        </a>
        <a href="#data" class="settings-nav-item" data-section="data">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Data & Backups
        </a>
        <a href="#users" class="settings-nav-item" data-section="users">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            Users
        </a>
        <a href="#appearance" class="settings-nav-item" data-section="appearance">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <circle cx="12" cy="12" r="3"></circle>
                <line x1="12" y1="2" x2="12" y2="5"></line>
                <line x1="12" y1="19" x2="12" y2="22"></line>
                <line x1="2" y1="12" x2="5" y2="12"></line>
                <line x1="19" y1="12" x2="22" y2="12"></line>
            </svg>
            Appearance
        </a>
    </nav>

    <!-- Settings Content -->
    <div class="settings-content">
        <!-- Account Section -->
        <section id="account" class="settings-section active">
            <div class="settings-section-header">
                <h2>Account Settings</h2>
                <p class="text-muted">Manage your profile and security</p>
            </div>

            <div class="card">
                <div class="card-body">
                    <p class="text-muted" style="margin-bottom: 1.5rem;">
                        Logged in as <strong>{{ user['name'] }}</strong> ({{ user['email'] }})
                    </p>

                    <!-- Change Name -->
                    <form method="POST" action="{{ url_for('change_name') }}" style="margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label">Display Name</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" name="new_name" class="form-control" value="{{ user['name'] }}" required>
                                <button type="submit" class="btn btn-secondary">Update</button>
                            </div>
                        </div>
                    </form>

                    <!-- Change Email -->
                    <form method="POST" action="{{ url_for('change_email') }}" style="margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" name="new_email" class="form-control" value="{{ user['email'] }}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm with Password</label>
                            <input type="password" name="password_for_email" class="form-control" placeholder="Enter your password" required>
                        </div>
                        <button type="submit" class="btn btn-secondary">Update Email</button>
                    </form>

                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--gray-200);">

                    <!-- Change Password -->
                    <h3 style="font-size: 1rem; margin-bottom: 1rem;">Change Password</h3>
                    <form method="POST" action="{{ url_for('change_password') }}">
                        <div class="form-group">
                            <label class="form-label">Current Password</label>
                            <input type="password" name="current_password" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">New Password</label>
                            <input type="password" name="new_password" class="form-control" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm New Password</label>
                            <input type="password" name="confirm_password" class="form-control" required minlength="6">
                        </div>
                        <button type="submit" class="btn btn-primary">Change Password</button>
                    </form>
                </div>
            </div>
        </section>

        <!-- API & Integrations Section -->
        <section id="integrations" class="settings-section">
            <div class="settings-section-header">
                <h2>API & Integrations</h2>
                <p class="text-muted">Connect external services and manage API access</p>
            </div>

            <div class="card">
                <div class="card-body">
                    <!-- API Key Section -->
                    <h3 style="font-size: 1rem; margin-bottom: 1rem;">API Key</h3>
                    {% if api_key %}
                    <div class="form-group">
                        <label class="form-label">Your API Key</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" class="form-control" value="{{ api_key }}" readonly id="apiKeyInput" style="font-family: monospace; font-size: 0.875rem;">
                            <button type="button" class="btn btn-secondary" onclick="copyApiKey()" title="Copy to clipboard">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        </div>
                        <p class="text-muted text-sm" style="margin-top: 0.5rem;">
                            Use this key in the <code>X-API-Key</code> header or <code>?api_key=</code> query parameter.
                        </p>
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <form method="POST" action="{{ url_for('generate_api_key') }}" style="display: inline;">
                            <button type="submit" class="btn btn-secondary" onclick="return confirm('Generate a new API key? The old key will stop working.')">Regenerate Key</button>
                        </form>
                        <form method="POST" action="{{ url_for('revoke_api_key') }}" style="display: inline;">
                            <button type="submit" class="btn btn-danger" onclick="return confirm('Revoke API key? All API access will be disabled.')">Revoke Key</button>
                        </form>
                    </div>
                    {% else %}
                    <p class="text-muted" style="margin-bottom: 1rem;">No API key configured. Generate one to enable API access.</p>
                    <form method="POST" action="{{ url_for('generate_api_key') }}" style="margin-bottom: 1.5rem;">
                        <button type="submit" class="btn btn-primary">Generate API Key</button>
                    </form>
                    {% endif %}

                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--gray-200);">

                    <!-- API Endpoints -->
                    <h3 style="font-size: 1rem; margin-bottom: 1rem;">API Endpoints</h3>

                    <div class="form-group">
                        <label class="form-label">GET Leads (fetch all leads)</label>
                        <code style="display: block; background: var(--gray-100); padding: 0.5rem; border-radius: 4px; font-size: 0.8125rem;">
                            GET {{ request.url_root }}api/leads
                        </code>
                        <p class="text-muted text-sm" style="margin-top: 0.25rem;">
                            Returns JSON array of all leads.
                        </p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">POST Lead (create new lead)</label>
                        <code style="display: block; background: var(--gray-100); padding: 0.5rem; border-radius: 4px; font-size: 0.8125rem;">
                            POST {{ request.url_root }}api/leads
                        </code>
                        <p class="text-muted text-sm" style="margin-top: 0.25rem;">
                            Send JSON body with: <code>name</code> (required), <code>email</code>, <code>phone</code>, <code>address</code>, <code>job_type</code>, <code>property_type</code>, <code>status</code>, <code>notes</code>
                        </p>
                    </div>

                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--gray-200);">

                    <!-- Google Places API -->
                    <h3 style="font-size: 1rem; margin-bottom: 1rem;">Google Places API (Address Autocomplete)</h3>
                    <form method="POST" action="{{ url_for('save_google_places_key') }}">
                        <div class="form-group">
                            <label class="form-label">Google Places API Key</label>
                            <input type="text" name="google_places_api_key" class="form-control"
                                   value="{{ google_places_api_key or '' }}"
                                   placeholder="AIzaSy...">
                            <p class="text-muted text-sm" style="margin-top: 0.5rem;">
                                Enable address autocomplete in lead forms.
                                <a href="https://developers.google.com/maps/documentation/places/web-service/get-api-key" target="_blank" rel="noopener">
                                    Get an API key from Google Cloud Console
                                </a>
                            </p>
                        </div>
                        <button type="submit" class="btn btn-primary">Save API Key</button>
                        {% if google_places_api_key %}
                        <button type="submit" name="remove_key" value="1" class="btn btn-secondary"
                                onclick="return confirm('Remove Google Places API key? Address autocomplete will be disabled.')">
                            Remove Key
                        </button>
                        {% endif %}
                    </form>

                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--gray-200);">

                    <!-- Outgoing Webhook -->
                    <h3 style="font-size: 1rem; margin-bottom: 1rem;">Outgoing Webhook (Zapier)</h3>
                    <form method="POST">
                        <div class="form-group">
                            <label class="form-label">Webhook URL</label>
                            <input type="url" name="zapier_webhook" class="form-control"
                                   value="{{ zapier_webhook }}"
                                   placeholder="https://hooks.zapier.com/hooks/catch/...">
                            <p class="text-muted text-sm" style="margin-top: 0.5rem;">
                                A POST request will be sent to this URL whenever a new lead is added.
                            </p>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Webhook</button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Data & Backups Section -->
        <section id="data" class="settings-section">
            <div class="settings-section-header">
                <h2>Data & Backups</h2>
                <p class="text-muted">Manage your database backups and deleted leads</p>
            </div>

            <div class="card">
                <div class="card-body">
                    <!-- Backup Status -->
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                        <div style="width: 48px; height: 48px; background: var(--success-light, #dcfce7); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                        </div>
                        <div>
                            {% if last_backup %}
                            <div style="font-weight: 500;">Last backup: {{ last_backup | strftime('%b %d, %Y at %I:%M %p') }}</div>
                            {% else %}
                            <div style="font-weight: 500;">No backups yet</div>
                            {% endif %}
                            <div class="text-muted text-sm">{{ backup_count }} backup(s) stored</div>
                        </div>
                    </div>

                    <!-- Manual Backup -->
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                        <form method="POST" action="{{ url_for('manual_backup') }}" style="display: inline;">
                            <button type="submit" class="btn btn-primary">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                Create Backup Now
                            </button>
                        </form>
                        {% if backup_count > 0 %}
                        <a href="{{ url_for('download_backup') }}" class="btn btn-secondary">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Download Latest
                        </a>
                        {% endif %}
                    </div>

                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--gray-200);">

                    <!-- Email Backup Settings -->
                    <h3 style="font-size: 1rem; margin-bottom: 1rem;">Email Backups</h3>
                    <form method="POST" action="{{ url_for('save_backup_email') }}">
                        <div class="form-group">
                            <label class="form-label">Send backups to email</label>
                            <input type="email" name="backup_email" class="form-control"
                                   value="{{ backup_email }}"
                                   placeholder="your@email.com">
                            <p class="text-muted text-sm" style="margin-top: 0.5rem;">
                                Requires SMTP configuration (see backup.py for setup instructions).
                            </p>
                        </div>
                        <button type="submit" class="btn btn-secondary">Save Email</button>
                    </form>

                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--gray-200);">

                    <!-- Trash Info -->
                    <h3 style="font-size: 1rem; margin-bottom: 1rem;">Trash</h3>
                    <p class="text-muted" style="margin-bottom: 0.75rem;">
                        {% if trash_count > 0 %}
                        <strong>{{ trash_count }}</strong> lead(s) in trash.
                        {% else %}
                        Trash is empty.
                        {% endif %}
                        Deleted leads can be restored from the trash.
                    </p>
                    <a href="{{ url_for('trash') }}" class="btn btn-secondary btn-sm">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        View Trash
                    </a>
                </div>
            </div>
        </section>

        <!-- Users Section -->
        <section id="users" class="settings-section">
            <div class="settings-section-header">
                <h2>User Management</h2>
                <p class="text-muted">Add and manage users who can access the CRM</p>
            </div>

            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="font-size: 1rem; margin: 0;">All Users</h3>
                    <button class="btn btn-primary btn-sm" onclick="document.getElementById('addUserModal').classList.add('visible')">
                        + Add User
                    </button>
                </div>
                <div class="card-body" style="padding: 0;">
                    <table class="grid-table" style="margin: 0;">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th style="width: 100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in users %}
                            <tr>
                                <td>
                                    <strong>{{ u['name'] }}</strong>
                                    {% if u['id'] == session.user_id %}
                                    <span class="text-muted text-sm">(you)</span>
                                    {% endif %}
                                </td>
                                <td class="text-muted">{{ u['email'] }}</td>
                                <td>
                                    <span class="badge" style="background: {% if u['role'] == 'admin' %}var(--primary){% else %}var(--gray-200){% endif %}; color: {% if u['role'] == 'admin' %}white{% else %}var(--gray-700){% endif %};">
                                        {{ u['role'] }}
                                    </span>
                                </td>
                                <td>
                                    {% if u['id'] != session.user_id %}
                                    <div style="display: flex; gap: 0.25rem;">
                                        <button class="btn btn-secondary btn-sm" onclick="openResetPassword({{ u['id'] }}, '{{ u['name'] }}')" title="Reset password">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                            </svg>
                                        </button>
                                        <form method="POST" action="{{ url_for('delete_user', id=u['id']) }}" style="display: inline;">
                                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Delete user {{ u['name'] }}?')" title="Delete user">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                                </svg>
                                            </button>
                                        </form>
                                    </div>
                                    {% else %}
                                    <span class="text-muted text-sm">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Appearance Section -->
        <section id="appearance" class="settings-section">
            <div class="settings-section-header">
                <h2>Appearance</h2>
                <p class="text-muted">Customize colors for statuses, job types, and property types</p>
            </div>

            <!-- Status Colors -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="font-size: 1rem; margin: 0;">Status Colors</h3>
                    <button class="btn btn-primary btn-sm" onclick="openAddStatusModal()">
                        + Add Status
                    </button>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div id="statusList" class="color-list">
                        <!-- Loaded via JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Job Type Colors -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <h3 style="font-size: 1rem; margin: 0;">Job Type Colors</h3>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div id="jobTypeList" class="color-list">
                        <!-- Loaded via JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Property Type Colors -->
            <div class="card">
                <div class="card-header">
                    <h3 style="font-size: 1rem; margin: 0;">Property Type Colors</h3>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div id="propertyTypeList" class="color-list">
                        <!-- Loaded via JavaScript -->
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Add Status Modal -->
<div id="addStatusModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3>Add New Status</h3>
            <button class="modal-close" onclick="document.getElementById('addStatusModal').classList.remove('visible')">&times;</button>
        </div>
        <form id="addStatusForm" onsubmit="return addNewStatus(event)">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Status Name *</label>
                    <input type="text" id="newStatusName" class="form-control" required placeholder="e.g., In Review">
                </div>
                <div class="form-group">
                    <label class="form-label">Color</label>
                    <div class="color-palette" id="newStatusColorPalette">
                        <!-- Color swatches loaded via JS -->
                    </div>
                    <input type="hidden" id="newStatusColor" value="#0073EA">
                    <input type="hidden" id="newStatusBgColor" value="#E6F4FF">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('addStatusModal').classList.remove('visible')">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Status</button>
            </div>
        </form>
    </div>
</div>

<!-- Color Picker Modal -->
<div id="colorPickerModal" class="modal-overlay">
    <div class="modal" style="max-width: 350px;">
        <div class="modal-header">
            <h3>Choose Color</h3>
            <button class="modal-close" onclick="closeColorPicker()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="color-palette" id="colorPalette">
                <!-- Color swatches loaded via JS -->
            </div>
            <div style="margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <span class="badge" id="colorPreview" style="padding: 0.5rem 1rem;">Preview</span>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeColorPicker()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="applyColor()">Apply</button>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div id="addUserModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3>Add New User</h3>
            <button class="modal-close" onclick="document.getElementById('addUserModal').classList.remove('visible')">&times;</button>
        </div>
        <form method="POST" action="{{ url_for('add_user') }}">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" name="name" class="form-control" required placeholder="John Smith">
                </div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" name="email" class="form-control" required placeholder="john@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password *</label>
                    <input type="password" name="password" class="form-control" required minlength="6" placeholder="Min 6 characters">
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select name="role" class="form-control">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('addUserModal').classList.remove('visible')">Cancel</button>
                <button type="submit" class="btn btn-primary">Add User</button>
            </div>
        </form>
    </div>
</div>

<!-- Reset Password Modal -->
<div id="resetPasswordModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3>Reset Password for <span id="resetUserName"></span></h3>
            <button class="modal-close" onclick="document.getElementById('resetPasswordModal').classList.remove('visible')">&times;</button>
        </div>
        <form method="POST" id="resetPasswordForm">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">New Password *</label>
                    <input type="password" name="new_password" class="form-control" required minlength="6" placeholder="Min 6 characters">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('resetPasswordModal').classList.remove('visible')">Cancel</button>
                <button type="submit" class="btn btn-primary">Reset Password</button>
            </div>
        </form>
    </div>
</div>

<style>
    .settings-layout {
        display: flex;
        gap: 2rem;
        max-width: 900px;
    }

    .settings-nav {
        width: 220px;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .settings-nav-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        color: var(--gray-600);
        text-decoration: none;
        font-weight: 500;
        transition: all 0.15s ease;
    }

    .settings-nav-item:hover {
        background: var(--gray-100);
        color: var(--gray-900);
    }

    .settings-nav-item.active {
        background: var(--primary);
        color: white;
    }

    .settings-nav-item.active svg {
        stroke: white;
    }

    .settings-content {
        flex: 1;
        min-width: 0;
    }

    .settings-section {
        display: none;
    }

    .settings-section.active {
        display: block;
    }

    .settings-section-header {
        margin-bottom: 1.5rem;
    }

    .settings-section-header h2 {
        margin: 0 0 0.25rem 0;
        font-size: 1.5rem;
    }

    .settings-section-header p {
        margin: 0;
    }

    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1001;
        align-items: center;
        justify-content: center;
    }
    .modal-overlay.visible {
        display: flex;
    }
    .modal {
        background: white;
        border-radius: 12px;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }
    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--gray-200);
    }
    .modal-header h3 {
        margin: 0;
        font-size: 1.125rem;
    }
    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--gray-500);
        cursor: pointer;
        padding: 0;
        line-height: 1;
    }
    .modal-body {
        padding: 1.5rem;
    }
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 1rem 1.5rem;
        border-top: 1px solid var(--gray-200);
        background: var(--gray-50);
        border-radius: 0 0 12px 12px;
    }

    @media (max-width: 768px) {
        .settings-layout {
            flex-direction: column;
            gap: 1rem;
        }

        .settings-nav {
            width: 100%;
            flex-direction: row;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            gap: 0.5rem;
        }

        .settings-nav-item {
            flex-shrink: 0;
            padding: 0.625rem 1rem;
            font-size: 0.875rem;
        }

        .settings-nav-item svg {
            width: 16px;
            height: 16px;
        }
    }

    /* Color Management Styles */
    .color-list {
        display: flex;
        flex-direction: column;
    }

    .color-list-item {
        display: flex;
        align-items: center;
        padding: 0.875rem 1rem;
        border-bottom: 1px solid var(--gray-100);
        gap: 1rem;
    }

    .color-list-item:last-child {
        border-bottom: none;
    }

    .color-swatch {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.15s ease;
        flex-shrink: 0;
    }

    .color-swatch:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .color-list-item .name {
        flex: 1;
        font-weight: 500;
        color: var(--gray-700);
    }

    .color-list-item .badge {
        flex-shrink: 0;
    }

    .color-list-item .actions {
        display: flex;
        gap: 0.5rem;
    }

    .color-palette {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 0.5rem;
    }

    .color-palette-swatch {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.15s ease;
    }

    .color-palette-swatch:hover {
        transform: scale(1.15);
        z-index: 1;
    }

    .color-palette-swatch.selected {
        border-color: var(--gray-800);
        box-shadow: 0 0 0 2px white, 0 0 0 4px var(--gray-800);
    }
</style>

<script>
    // Settings navigation
    document.querySelectorAll('.settings-nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const sectionId = this.dataset.section;

            // Update nav active state
            document.querySelectorAll('.settings-nav-item').forEach(nav => nav.classList.remove('active'));
            this.classList.add('active');

            // Show selected section
            document.querySelectorAll('.settings-section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');

            // Update URL hash
            history.replaceState(null, null, '#' + sectionId);
        });
    });

    // Handle initial hash
    function showSectionFromHash() {
        const hash = window.location.hash.slice(1);
        if (hash) {
            const navItem = document.querySelector(`.settings-nav-item[data-section="${hash}"]`);
            if (navItem) {
                navItem.click();
            }
        }
    }
    showSectionFromHash();

    function copyApiKey() {
        const input = document.getElementById('apiKeyInput');
        input.select();
        input.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(input.value).then(() => {
            showToast('API key copied to clipboard', 'success');
        }).catch(() => {
            document.execCommand('copy');
            showToast('API key copied to clipboard', 'success');
        });
    }

    function openResetPassword(userId, userName) {
        document.getElementById('resetUserName').textContent = userName;
        document.getElementById('resetPasswordForm').action = '/users/' + userId + '/reset-password';
        document.getElementById('resetPasswordModal').classList.add('visible');
    }

    // Close modals on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.getElementById('addUserModal').classList.remove('visible');
            document.getElementById('resetPasswordModal').classList.remove('visible');
        }
    });

    // Close modals when clicking overlay
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('visible');
            }
        });
    });

    // ===== Color Management =====

    // Monday.com color palette
    const MONDAY_COLORS = [
        { color: '#0073EA', bg: '#E6F4FF' },  // Blue
        { color: '#00C875', bg: '#E5FBF3' },  // Green
        { color: '#A25DDC', bg: '#F4ECFB' },  // Purple
        { color: '#FDAB3D', bg: '#FFF4E5' },  // Orange
        { color: '#E2445C', bg: '#FFE5E9' },  // Red
        { color: '#FF158A', bg: '#FFE5F0' },  // Pink
        { color: '#579BFC', bg: '#E5F0FF' },  // Sky
        { color: '#FFCB00', bg: '#FFF9E5' },  // Yellow
        { color: '#00D2D2', bg: '#E5FAFA' },  // Teal
        { color: '#037F4C', bg: '#E5F5ED' },  // Dark Green
        { color: '#9AADBD', bg: '#F0F3F6' },  // Gray
        { color: '#CAB641', bg: '#FAF7E5' },  // Olive
        { color: '#7F5347', bg: '#F5EDEB' },  // Brown
        { color: '#FF5AC4', bg: '#FFE5F4' },  // Magenta
        { color: '#784BD1', bg: '#F0EAFB' },  // Indigo
        { color: '#66CCFF', bg: '#E5F7FF' },  // Light Blue
    ];

    let currentColorTarget = null;
    let selectedColor = MONDAY_COLORS[0];

    // Initialize palettes
    function initColorPalettes() {
        const palette = document.getElementById('colorPalette');
        const newStatusPalette = document.getElementById('newStatusColorPalette');

        if (palette) {
            palette.innerHTML = MONDAY_COLORS.map((c, i) => `
                <div class="color-palette-swatch${i === 0 ? ' selected' : ''}"
                     style="background: ${c.color}"
                     data-color="${c.color}"
                     data-bg="${c.bg}"
                     onclick="selectColor(this, ${i})"></div>
            `).join('');
        }

        if (newStatusPalette) {
            newStatusPalette.innerHTML = MONDAY_COLORS.map((c, i) => `
                <div class="color-palette-swatch${i === 0 ? ' selected' : ''}"
                     style="background: ${c.color}"
                     data-color="${c.color}"
                     data-bg="${c.bg}"
                     onclick="selectNewStatusColor(this, ${i})"></div>
            `).join('');
        }
    }

    function selectColor(el, index) {
        document.querySelectorAll('#colorPalette .color-palette-swatch').forEach(s => s.classList.remove('selected'));
        el.classList.add('selected');
        selectedColor = MONDAY_COLORS[index];

        const preview = document.getElementById('colorPreview');
        if (preview) {
            preview.style.background = selectedColor.bg;
            preview.style.color = selectedColor.color;
        }
    }

    function selectNewStatusColor(el, index) {
        document.querySelectorAll('#newStatusColorPalette .color-palette-swatch').forEach(s => s.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('newStatusColor').value = MONDAY_COLORS[index].color;
        document.getElementById('newStatusBgColor').value = MONDAY_COLORS[index].bg;
    }

    function openColorPicker(type, id, name, currentColor) {
        currentColorTarget = { type, id, name };

        // Find and select current color
        const index = MONDAY_COLORS.findIndex(c => c.color === currentColor);
        if (index >= 0) {
            selectedColor = MONDAY_COLORS[index];
            document.querySelectorAll('#colorPalette .color-palette-swatch').forEach((s, i) => {
                s.classList.toggle('selected', i === index);
            });
        }

        const preview = document.getElementById('colorPreview');
        if (preview) {
            preview.textContent = name;
            preview.style.background = selectedColor.bg;
            preview.style.color = selectedColor.color;
        }

        document.getElementById('colorPickerModal').classList.add('visible');
    }

    function closeColorPicker() {
        document.getElementById('colorPickerModal').classList.remove('visible');
        currentColorTarget = null;
    }

    async function applyColor() {
        if (!currentColorTarget) return;

        const { type, id } = currentColorTarget;
        let endpoint = '';

        if (type === 'status') {
            endpoint = `/api/statuses/${id}/color`;
        } else if (type === 'job_type') {
            endpoint = `/api/job-types/${id}/color`;
        } else if (type === 'property_type') {
            endpoint = `/api/property-types/${id}/color`;
        }

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    color: selectedColor.color,
                    bg_color: selectedColor.bg
                })
            });

            if (response.ok) {
                showToast('Color updated!', 'success');
                loadAppearanceData();
                closeColorPicker();
            } else {
                showToast('Failed to update color', 'error');
            }
        } catch (error) {
            showToast('Error updating color', 'error');
        }
    }

    // Load appearance data
    async function loadAppearanceData() {
        await Promise.all([
            loadStatuses(),
            loadJobTypes(),
            loadPropertyTypes()
        ]);
    }

    async function loadStatuses() {
        try {
            const response = await fetch('/api/statuses');
            const statuses = await response.json();
            renderStatusList(statuses);
        } catch (error) {
            console.error('Failed to load statuses:', error);
        }
    }

    function renderStatusList(statuses) {
        const list = document.getElementById('statusList');
        if (!list) return;

        list.innerHTML = statuses.map(s => `
            <div class="color-list-item" data-id="${s.id}">
                <div class="color-swatch" style="background: ${s.color}"
                     onclick="openColorPicker('status', ${s.id}, '${s.name}', '${s.color}')"></div>
                <span class="name">${s.name}</span>
                <span class="badge" style="background: ${s.bg_color}; color: ${s.color};">${s.name}</span>
                <div class="actions">
                    <button class="btn btn-danger btn-sm" onclick="deleteStatus(${s.id}, '${s.name}')" title="Delete">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `).join('');
    }

    async function loadJobTypes() {
        try {
            const response = await fetch('/api/job-types');
            const types = await response.json();
            renderJobTypeList(types);
        } catch (error) {
            console.error('Failed to load job types:', error);
        }
    }

    function renderJobTypeList(types) {
        const list = document.getElementById('jobTypeList');
        if (!list) return;

        list.innerHTML = types.map(t => `
            <div class="color-list-item" data-id="${t.id}">
                <div class="color-swatch" style="background: ${t.color}"
                     onclick="openColorPicker('job_type', ${t.id}, '${t.name}', '${t.color}')"></div>
                <span class="name">${t.name}</span>
                <span class="badge" style="background: ${t.color}20; color: ${t.color};">${t.name}</span>
            </div>
        `).join('');
    }

    async function loadPropertyTypes() {
        try {
            const response = await fetch('/api/property-types');
            const types = await response.json();
            renderPropertyTypeList(types);
        } catch (error) {
            console.error('Failed to load property types:', error);
        }
    }

    function renderPropertyTypeList(types) {
        const list = document.getElementById('propertyTypeList');
        if (!list) return;

        list.innerHTML = types.map(t => `
            <div class="color-list-item" data-id="${t.id}">
                <div class="color-swatch" style="background: ${t.color}"
                     onclick="openColorPicker('property_type', ${t.id}, '${t.name}', '${t.color}')"></div>
                <span class="name">${t.name}</span>
                <span class="badge" style="background: ${t.color}20; color: ${t.color};">${t.name}</span>
            </div>
        `).join('');
    }

    // Add status modal
    function openAddStatusModal() {
        document.getElementById('newStatusName').value = '';
        document.getElementById('addStatusModal').classList.add('visible');
    }

    async function addNewStatus(e) {
        e.preventDefault();

        const name = document.getElementById('newStatusName').value.trim();
        const color = document.getElementById('newStatusColor').value;
        const bgColor = document.getElementById('newStatusBgColor').value;

        if (!name) return false;

        try {
            const response = await fetch('/api/statuses', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, color, bg_color: bgColor })
            });

            if (response.ok) {
                showToast('Status added!', 'success');
                document.getElementById('addStatusModal').classList.remove('visible');
                loadStatuses();
            } else {
                const data = await response.json();
                showToast(data.error || 'Failed to add status', 'error');
            }
        } catch (error) {
            showToast('Error adding status', 'error');
        }

        return false;
    }

    async function deleteStatus(id, name) {
        if (!confirm(`Delete status "${name}"? Leads with this status will need to be updated.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/statuses/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showToast('Status deleted', 'success');
                loadStatuses();
            } else {
                const data = await response.json();
                showToast(data.error || 'Failed to delete status', 'error');
            }
        } catch (error) {
            showToast('Error deleting status', 'error');
        }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initColorPalettes();

        // Load appearance data when that section is shown
        const appearanceNav = document.querySelector('[data-section="appearance"]');
        if (appearanceNav) {
            appearanceNav.addEventListener('click', function() {
                loadAppearanceData();
            });
        }

        // If starting on appearance section, load data
        if (window.location.hash === '#appearance') {
            loadAppearanceData();
        }
    });
</script>
{% endblock %}
