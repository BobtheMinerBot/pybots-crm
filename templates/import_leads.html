{% extends 'base.html' %}

{% block title %}Import Leads - CRM{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <div class="card-header">
            <h2>üì§ Import Leads from CSV</h2>
            <a href="{{ url_for('leads') }}" class="btn btn-secondary">‚Üê Back to Leads</a>
        </div>
        <div class="card-body">
            <!-- Instructions -->
            <div class="import-instructions"
                style="background: var(--gray-50); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">üìã How to Import</h3>
                <ol style="margin-left: 1.5rem; color: var(--gray-600); font-size: 0.875rem;">
                    <li>Upload your CSV file (exports from SmartSuite, JobTread, Excel, etc.)</li>
                    <li>Map CSV columns to CRM fields (we'll auto-detect what we can)</li>
                    <li>Choose how to handle duplicates</li>
                    <li>Preview and import!</li>
                </ol>
            </div>

            <!-- Upload Form -->
            <form id="importForm" action="{{ url_for('import_leads') }}" method="POST" enctype="multipart/form-data">
                <!-- Step 1: File Upload -->
                <div class="form-group">
                    <label class="form-label">Step 1: Upload CSV File</label>
                    <div class="file-upload-area" id="dropZone"
                        style="border: 2px dashed var(--gray-300); border-radius: 0.5rem; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s;">
                        <input type="file" name="csv_file" id="csvFile" accept=".csv" style="display: none;" required>
                        <div class="upload-icon" style="font-size: 2rem; margin-bottom: 0.5rem;">üìÅ</div>
                        <p style="color: var(--gray-600); margin-bottom: 0.5rem;">Drag and drop your CSV file here, or click to browse</p>
                        <p id="fileName" style="color: var(--primary); font-weight: 500;"></p>
                    </div>
                </div>

                <!-- Step 2: Column Mapping (shown after file upload) -->
                <div id="mappingSection" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Step 2: Map Columns</label>
                        <p style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 1rem;">
                            Match your CSV columns to CRM fields. We've auto-detected some mappings ‚Äî review and adjust as needed.
                        </p>
                        
                        <!-- Mapping Stats -->
                        <div id="mappingStats" style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <span class="badge" style="background: var(--green-100); color: var(--green-700); padding: 0.25rem 0.75rem; border-radius: 1rem;">
                                <span id="mappedCount">0</span> mapped
                            </span>
                            <span class="badge" style="background: var(--gray-100); color: var(--gray-600); padding: 0.25rem 0.75rem; border-radius: 1rem;">
                                <span id="skippedCount">0</span> skipped
                            </span>
                        </div>
                        
                        <div id="columnMappings" class="mapping-grid"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                            <!-- Mappings will be inserted here -->
                        </div>
                    </div>

                    <!-- Step 3: Import Options -->
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label class="form-label">Step 3: Duplicate Handling</label>
                        <p style="color: var(--gray-500); font-size: 0.8125rem; margin-bottom: 0.75rem;">
                            Duplicates are matched by email first, then by name.
                        </p>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <label class="radio-option" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 1rem; border: 1px solid var(--gray-200); border-radius: 0.375rem;">
                                <input type="radio" name="duplicate_action" value="skip" checked>
                                <span>Skip duplicates</span>
                            </label>
                            <label class="radio-option" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 1rem; border: 1px solid var(--gray-200); border-radius: 0.375rem;">
                                <input type="radio" name="duplicate_action" value="update">
                                <span>Update existing</span>
                            </label>
                            <label class="radio-option" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 1rem; border: 1px solid var(--gray-200); border-radius: 0.375rem;">
                                <input type="radio" name="duplicate_action" value="create">
                                <span>Create anyway</span>
                            </label>
                        </div>
                    </div>

                    <!-- Preview Table -->
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label class="form-label">Preview (first 5 rows)</label>
                        <div style="overflow-x: auto; border: 1px solid var(--gray-200); border-radius: 0.5rem;">
                            <table id="previewTable" class="grid-table" style="min-width: 100%;">
                                <thead id="previewHead"></thead>
                                <tbody id="previewBody"></tbody>
                            </table>
                        </div>
                        <p id="totalRows" style="color: var(--gray-600); font-size: 0.875rem; margin-top: 0.5rem;"></p>
                    </div>

                    <!-- Submit -->
                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button type="submit" class="btn btn-primary" id="importBtn">
                            üì• Import Leads
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            üîÑ Reset
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .file-upload-area:hover,
    .file-upload-area.dragover {
        border-color: var(--primary);
        background: var(--primary-light, #e6f4ff);
    }

    .mapping-item {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: 0.5rem;
        padding: 1rem;
        transition: all 0.2s;
    }
    
    .mapping-item:hover {
        border-color: var(--primary);
    }
    
    .mapping-item.mapped {
        border-left: 3px solid var(--green-500, #00C875);
    }
    
    .mapping-item.skipped {
        opacity: 0.6;
    }

    .mapping-item .csv-column {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .mapping-item .csv-column .sample {
        font-weight: normal;
        color: var(--gray-500);
        font-size: 0.75rem;
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .mapping-item select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--gray-300);
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }
    
    .mapping-item select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px var(--primary-light, #e6f4ff);
    }

    .radio-option:has(input:checked) {
        border-color: var(--primary);
        background: var(--primary-light, #e6f4ff);
    }

    #previewTable th {
        background: var(--gray-50);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    #previewTable td {
        font-size: 0.8125rem;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Mobile responsive styles */
    @media (max-width: 768px) {
        .card-header {
            flex-direction: column;
            gap: 0.75rem;
            align-items: flex-start;
        }

        .card-header .btn {
            width: 100%;
            justify-content: center;
        }

        .import-instructions ol {
            margin-left: 1rem;
        }

        .file-upload-area {
            padding: 1.5rem !important;
        }

        .mapping-grid {
            grid-template-columns: 1fr !important;
        }

        div[style*="display: flex; gap: 1rem; flex-wrap: wrap"] {
            flex-direction: column;
        }

        .radio-option {
            width: 100%;
        }

        #importBtn {
            width: 100%;
        }
    }
</style>

<script>
    const dropZone = document.getElementById('dropZone');
    const csvFile = document.getElementById('csvFile');
    const fileName = document.getElementById('fileName');
    const mappingSection = document.getElementById('mappingSection');
    const columnMappings = document.getElementById('columnMappings');
    const previewHead = document.getElementById('previewHead');
    const previewBody = document.getElementById('previewBody');
    const totalRows = document.getElementById('totalRows');
    const mappedCount = document.getElementById('mappedCount');
    const skippedCount = document.getElementById('skippedCount');

    // Field definitions from server
    const leadFields = {{ lead_fields | tojson }};
    const defaultMappings = {{ default_mappings | tojson }};
    
    // Store parsed data
    let csvHeaders = [];
    let csvRows = [];
    let autoMappings = {};

    // Drag and drop handling
    dropZone.addEventListener('click', () => csvFile.click());
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            csvFile.files = e.dataTransfer.files;
            handleFileSelect();
        }
    });

    csvFile.addEventListener('change', handleFileSelect);

    function handleFileSelect() {
        if (csvFile.files.length) {
            const file = csvFile.files[0];
            fileName.textContent = '‚úì ' + file.name;
            parseCSV(file);
        }
    }

    function parseCSV(file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            const text = e.target.result;
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length === 0) return;

            // Parse headers (handle BOM)
            let headerLine = lines[0];
            if (headerLine.charCodeAt(0) === 0xFEFF) {
                headerLine = headerLine.slice(1);
            }
            csvHeaders = parseCSVLine(headerLine);

            // Parse all rows
            csvRows = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const row = {};
                csvHeaders.forEach((h, idx) => row[h] = values[idx] || '');
                csvRows.push(row);
            }

            // Auto-detect mappings
            autoMappings = detectMappings(csvHeaders);

            // Build mapping UI
            buildMappingUI(csvHeaders, csvRows);

            // Build preview table
            buildPreviewTable(csvHeaders, csvRows.slice(0, 5));

            totalRows.textContent = `Total rows in file: ${csvRows.length}`;
            mappingSection.style.display = 'block';
            
            // Scroll to mapping section
            mappingSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        };
        reader.readAsText(file);
    }

    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
                if (inQuotes && line[i + 1] === '"') {
                    current += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ',' && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current.trim());
        return result;
    }

    function detectMappings(headers) {
        const mappings = {};
        const usedFields = new Set();
        
        // First pass: exact matches
        headers.forEach(header => {
            const headerLower = header.toLowerCase().trim();
            
            // Check default mappings first
            if (defaultMappings[header]) {
                mappings[header] = defaultMappings[header];
                usedFields.add(defaultMappings[header]);
                return;
            }
            
            // Check lead fields for exact match
            for (const field of leadFields) {
                if (usedFields.has(field.key)) continue;
                
                const fieldLabel = field.label.toLowerCase();
                const fieldKey = field.key.toLowerCase().replace('custom_', '');
                
                if (headerLower === fieldLabel || headerLower === fieldKey) {
                    mappings[header] = field.key;
                    usedFields.add(field.key);
                    return;
                }
            }
        });
        
        // Second pass: fuzzy matches
        const fuzzyMatches = {
            'name': ['name', 'customer', 'client', 'contact', 'full name', 'customer name'],
            'email': ['email', 'e-mail', 'mail'],
            'phone': ['phone', 'telephone', 'tel', 'mobile', 'cell'],
            'address': ['address', 'location', 'site', 'street'],
            'job_type': ['job type', 'type', 'service', 'work type'],
            'property_type': ['property type', 'property'],
            'status': ['status', 'stage', 'state'],
            'notes': ['notes', 'note', 'comments', 'description', 'scope']
        };
        
        headers.forEach(header => {
            if (mappings[header]) return; // Already mapped
            
            const headerNorm = header.toLowerCase().replace(/[_-]/g, ' ').trim();
            
            for (const [fieldKey, keywords] of Object.entries(fuzzyMatches)) {
                if (usedFields.has(fieldKey)) continue;
                
                for (const kw of keywords) {
                    if (headerNorm.includes(kw) || kw.includes(headerNorm)) {
                        mappings[header] = fieldKey;
                        usedFields.add(fieldKey);
                        return;
                    }
                }
            }
            
            // Check custom fields
            for (const field of leadFields) {
                if (!field.is_custom || usedFields.has(field.key)) continue;
                
                const fieldLabel = field.label.toLowerCase().replace(/[_-]/g, ' ');
                if (headerNorm.includes(fieldLabel) || fieldLabel.includes(headerNorm)) {
                    mappings[header] = field.key;
                    usedFields.add(field.key);
                    return;
                }
            }
        });
        
        return mappings;
    }

    function buildMappingUI(headers, rows) {
        columnMappings.innerHTML = '';
        
        // Get sample values for each column
        const samples = {};
        headers.forEach(h => {
            for (const row of rows.slice(0, 3)) {
                if (row[h] && row[h].trim()) {
                    samples[h] = row[h].trim().substring(0, 50);
                    break;
                }
            }
        });
        
        headers.forEach(header => {
            const autoMapping = autoMappings[header] || 'skip';
            const isMapped = autoMapping !== 'skip';
            
            const div = document.createElement('div');
            div.className = `mapping-item ${isMapped ? 'mapped' : 'skipped'}`;
            div.innerHTML = `
                <div class="csv-column">
                    <span>${escapeHtml(header)}</span>
                    ${samples[header] ? `<span class="sample">"${escapeHtml(samples[header])}"</span>` : ''}
                </div>
                <select name="mapping_${escapeHtml(header)}" class="form-control mapping-select" data-header="${escapeHtml(header)}">
                    <option value="skip">-- Skip this column --</option>
                    <optgroup label="Default Fields">
                        ${leadFields.filter(f => !f.is_custom).map(f => 
                            `<option value="${f.key}" ${autoMapping === f.key ? 'selected' : ''}>${f.label}${f.required ? ' *' : ''}</option>`
                        ).join('')}
                    </optgroup>
                    ${leadFields.some(f => f.is_custom) ? `
                    <optgroup label="Custom Fields">
                        ${leadFields.filter(f => f.is_custom).map(f => 
                            `<option value="${f.key}" ${autoMapping === f.key ? 'selected' : ''}>${f.label}</option>`
                        ).join('')}
                    </optgroup>
                    ` : ''}
                </select>
            `;
            columnMappings.appendChild(div);
            
            // Add change listener
            const select = div.querySelector('select');
            select.addEventListener('change', () => {
                updateMappingState(div, select.value);
                updateMappingCounts();
            });
        });
        
        updateMappingCounts();
    }
    
    function updateMappingState(div, value) {
        div.classList.remove('mapped', 'skipped');
        div.classList.add(value === 'skip' ? 'skipped' : 'mapped');
    }
    
    function updateMappingCounts() {
        const selects = document.querySelectorAll('.mapping-select');
        let mapped = 0, skipped = 0;
        selects.forEach(s => {
            if (s.value === 'skip') skipped++;
            else mapped++;
        });
        mappedCount.textContent = mapped;
        skippedCount.textContent = skipped;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function buildPreviewTable(headers, rows) {
        // Show mapped field names in header
        const getMappedName = (header) => {
            const mapping = autoMappings[header];
            if (!mapping || mapping === 'skip') return header;
            const field = leadFields.find(f => f.key === mapping);
            return field ? `${header} ‚Üí ${field.label}` : header;
        };
        
        previewHead.innerHTML = '<tr>' + headers.map(h => 
            `<th title="${escapeHtml(h)}">${escapeHtml(getMappedName(h))}</th>`
        ).join('') + '</tr>';
        
        previewBody.innerHTML = rows.map(row =>
            '<tr>' + headers.map(h => `<td title="${escapeHtml(row[h] || '')}">${escapeHtml(row[h] || '')}</td>`).join('') + '</tr>'
        ).join('');
    }

    function resetForm() {
        csvFile.value = '';
        fileName.textContent = '';
        mappingSection.style.display = 'none';
        columnMappings.innerHTML = '';
        previewHead.innerHTML = '';
        previewBody.innerHTML = '';
        csvHeaders = [];
        csvRows = [];
        autoMappings = {};
    }
    
    // Form submission validation
    document.getElementById('importForm').addEventListener('submit', function(e) {
        // Check if at least 'name' is mapped
        const selects = document.querySelectorAll('.mapping-select');
        let hasName = false;
        selects.forEach(s => {
            if (s.value === 'name') hasName = true;
        });
        
        if (!hasName) {
            e.preventDefault();
            alert('Please map at least the "Name" field to import leads.');
            return false;
        }
    });
</script>
{% endblock %}
